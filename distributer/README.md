# åˆ†é…å™¨æœåŠ¡ (Distributer Service)

## ğŸ“‹ æ¦‚è¿°

åˆ†é…å™¨æœåŠ¡æ˜¯CUCDFDæ·±åº¦é‰´ä¼ªç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦ç»„ä»¶ï¼Œä½œä¸ºFlask WebæœåŠ¡è¿è¡Œã€‚å®ƒè´Ÿè´£æ¥æ”¶æ¥è‡ªWebå‰ç«¯çš„æ£€æµ‹ä»»åŠ¡è¯·æ±‚ï¼Œå°†ä»»åŠ¡åˆ†å‘ç»™å¯ç”¨çš„æ£€æµ‹æœåŠ¡å®ä¾‹ï¼Œå¹¶ç®¡ç†ä»»åŠ¡çŠ¶æ€å’Œç»“æœä¼ é€’ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **ä»»åŠ¡åˆ†å‘**ï¼šæ ¹æ®æ£€æµ‹æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå°†æ–°ä»»åŠ¡éšæœºåˆ†é…ç»™ç©ºé—²çš„æœåŠ¡å™¨
- **çŠ¶æ€ç®¡ç†**ï¼šå®šæœŸæ£€æŸ¥æ£€æµ‹æœåŠ¡çš„çŠ¶æ€ï¼ˆç©ºé—²/ç¹å¿™ï¼‰
- **ä»»åŠ¡è·Ÿè¸ª**ï¼šä¸ºæ¯ä¸ªä»»åŠ¡ç”Ÿæˆå”¯ä¸€çš„IDï¼Œå¹¶è®°å½•ä»»åŠ¡åˆ†é…ç»™äº†å“ªä¸ªæœåŠ¡å™¨ä»¥åŠä»»åŠ¡çš„å½“å‰çŠ¶æ€
- **ç»“æœè·å–**ï¼šå½“å®¢æˆ·ç«¯æŸ¥è¯¢ä»»åŠ¡ç»“æœæ—¶ï¼Œå¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œåˆ™ä»ç›¸åº”çš„æ£€æµ‹æœåŠ¡è·å–ç»“æœæ•°æ®ï¼ˆåŒ…æ‹¬æ–‡ä»¶ï¼‰ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯
- **é…ç½®çµæ´»**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†åˆ†é…å™¨ç«¯å£å’Œæ£€æµ‹æœåŠ¡åˆ—è¡¨

### ğŸ—ï¸ æ¶æ„ä½ç½®

```
Webå‰ç«¯ (8080) â”€â”€â†’ åˆ†é…å™¨æœåŠ¡ (5000) â”€â”€â†’ æ£€æµ‹æœåŠ¡ç¾¤ (35331+)
    â”‚                    â”‚                      â”‚
  ç”¨æˆ·äº¤äº’              ä»»åŠ¡è°ƒåº¦              AIæ¨¡å‹æ¨ç†
  æ–‡ä»¶ä¸Šä¼               è´Ÿè½½å‡è¡¡              ç»“æœç”Ÿæˆ
```

## âš™ï¸ é…ç½®è¯´æ˜

### ä¸»é…ç½®æ–‡ä»¶

åˆ†é…å™¨æ”¯æŒä¸¤ç§é…ç½®æ–¹å¼ï¼š

#### 1. ä½¿ç”¨é¡¹ç›®ä¸»é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

é€šè¿‡é¡¹ç›®æ ¹ç›®å½•çš„ `config.yml` æ–‡ä»¶è¿›è¡Œé…ç½®ï¼š

```yaml
# åˆ†é…å™¨æ¨¡å—é…ç½®
distributer_module:
  port: 5000                    # åˆ†é…å™¨ç›‘å¬ç«¯å£
  worker_servers:              # æ£€æµ‹æœåŠ¡å®ä¾‹åˆ—è¡¨
    - name: "service_1"        # æœåŠ¡åç§°
      url: "http://0.0.0.0:35331"  # æœåŠ¡åœ°å€
    - name: "service_2"
      url: "http://0.0.0.0:35332"
```

#### 2. ä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶ï¼ˆå‘åå…¼å®¹ï¼‰

åœ¨åˆ†é…å™¨ç›®å½•ä¸‹çš„ `config.yml` æ–‡ä»¶ï¼š

```yaml
distributer_port: 5000
# åˆ†é…å™¨çš„ç«¯å£å·ï¼Œé»˜è®¤æ˜¯5000

worker_servers:
  - "0.0.0.0:35331"  # ä¾‹å¦‚ "192.168.1.101:35331"
  - "0.0.0.0:35332"  # ä¾‹å¦‚ "192.168.1.102:35332"
#  - "another.worker.ip:port" # å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šæœåŠ¡å™¨
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `port` | int | 5000 | åˆ†é…å™¨æœåŠ¡ç›‘å¬ç«¯å£ |
| `worker_servers` | list | - | æ£€æµ‹æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨ |

## ğŸš€ å¯åŠ¨å’Œåœæ­¢

### ä½¿ç”¨ç³»ç»Ÿè„šæœ¬å¯åŠ¨ï¼ˆæ¨èï¼‰

åˆ†é…å™¨æœåŠ¡é€šè¿‡é¡¹ç›®æ ¹ç›®å½•çš„å¯åŠ¨è„šæœ¬ç®¡ç†ï¼š

```bash
# å¯åŠ¨æ•´ä¸ªç³»ç»Ÿï¼ˆåŒ…æ‹¬åˆ†é…å™¨ï¼‰
./start_all.sh

# åœæ­¢æ•´ä¸ªç³»ç»Ÿ
./stop_all.sh
```

### å•ç‹¬ç®¡ç†åˆ†é…å™¨æœåŠ¡

```bash
# è¿›å…¥åˆ†é…å™¨ç›®å½•
cd distributer

# æ¿€æ´»Condaç¯å¢ƒ
conda activate cucdfd

# ä½¿ç”¨ä¸»é…ç½®æ–‡ä»¶å¯åŠ¨ï¼ˆæ¨èï¼‰
python distributer.py --config ../config.yml

# ä½¿ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶å¯åŠ¨
python distributer.py

# åå°å¯åŠ¨ï¼ˆä½¿ç”¨screenï¼‰
screen -dmS cucdfd_distributer python distributer.py --config ../config.yml

# æŸ¥çœ‹åå°è¿è¡ŒçŠ¶æ€
screen -r cucdfd_distributer

# ä»screenä¼šè¯é€€å‡ºï¼ˆä¸ç»ˆæ­¢æœåŠ¡ï¼‰
# æŒ‰ Ctrl+Aï¼Œç„¶åæŒ‰ D

# åœæ­¢åå°æœåŠ¡
screen -S cucdfd_distributer -X quit
```

### æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tuln | grep :5000
netstat -tlnp | grep :5000

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep distributer.py

# æ£€æŸ¥Screenä¼šè¯
screen -ls | grep distributer

# æµ‹è¯•æœåŠ¡å“åº”
curl http://localhost:5000/
```

## ğŸ”Œ APIæ¥å£æ–‡æ¡£

### 1. æäº¤æ£€æµ‹ä»»åŠ¡

**æ¥å£**: `POST /taskdoor`

**åŠŸèƒ½**: æ¥æ”¶æ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼Œå°†ä»»åŠ¡åˆ†å‘ç»™å¯ç”¨çš„æ£€æµ‹æœåŠ¡

**è¯·æ±‚æ ¼å¼**:
```http
POST /taskdoor
Content-Type: multipart/form-data

# é€šè¿‡æ–‡ä»¶ä¸Šä¼ 
file: [åª’ä½“æ–‡ä»¶]

# æˆ–é€šè¿‡URLæäº¤
url: [åª’ä½“æ–‡ä»¶URL]
```

**å“åº”æ ¼å¼**:
```json
{
  "taskid": "abc123",
  "status": 200
}
```

**çŠ¶æ€ç **:
- `200`: ä»»åŠ¡æäº¤æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `413`: æ–‡ä»¶è¿‡å¤§
- `502`: URLå¤„ç†å¤±è´¥
- `503`: æ‰€æœ‰æ£€æµ‹æœåŠ¡ä¸å¯ç”¨
- `504`: ä¸æ£€æµ‹æœåŠ¡é€šä¿¡è¶…æ—¶

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å’Œç»“æœ

**æ¥å£**: `POST /check`

**åŠŸèƒ½**: æŸ¥è¯¢æŒ‡å®šä»»åŠ¡çš„å¤„ç†çŠ¶æ€å’Œç»“æœ

**è¯·æ±‚æ ¼å¼**:
```http
POST /check
Content-Type: application/x-www-form-urlencoded

taskid=abc123def456
```

**å“åº”æ ¼å¼ï¼ˆå¤„ç†ä¸­ï¼‰**:
```json
{
  "status": 0.6
}
```

**å“åº”æ ¼å¼ï¼ˆå·²å®Œæˆï¼‰**:
```json
{
  "status": 1,
  "data": {
    "config_id": "abc123def456",
    "filename": "test_video.mp4",
    "tampered_list": ["è§†é¢‘ä¼ªé€ -è§†é¢‘ç”»é¢å†…å®¹ä¼ªé€ "],
    "tampered_vidfragment_str": "è§†é¢‘ç¬¬0æ®µä¸ºä¼ªé€ ï¼Œä¼ªé€ æ—¶é—´æ®µä¸º1.23~4.56ç§’ï¼Œç½®ä¿¡åº¦ä¸º0.88ã€‚",
    "tampered_audiofragment_str": null,
    "tampered_imagefragment_str": null
  }
}
```

**å“åº”æ ¼å¼ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰**:
```json
{
  "status": -1.0,
  "message": "Failed to get results from worker or error during processing."
}
```

**çŠ¶æ€ç è¯´æ˜**:
- `1.0`: å¤„ç†å®Œæˆ
- `0.0 - 0.99`: å¤„ç†ä¸­ï¼ˆè¿›åº¦å€¼ï¼‰
- `-1.0`: å¤„ç†å¤±è´¥
- `-1.1`: ä¸æ£€æµ‹æœåŠ¡é€šä¿¡è¶…æ—¶

### 3. è·å–æ£€æµ‹æœåŠ¡çŠ¶æ€

**æ¥å£**: `GET /simplecheck`

**åŠŸèƒ½**: è·å–æ‰€æœ‰æ£€æµ‹æœåŠ¡çš„å®æ—¶çŠ¶æ€ä¿¡æ¯

**å“åº”æ ¼å¼**:
```json
{
  "0.0.0.0:35331": "0",
  "0.0.0.0:35332": "1"
}
```

**çŠ¶æ€å€¼è¯´æ˜**:
- `"0"`: æ£€æµ‹æœåŠ¡ç©ºé—²ï¼Œå¯æ¥æ”¶ä»»åŠ¡
- `"1"`: æ£€æµ‹æœåŠ¡ç¹å¿™æˆ–ä¸å¯ç”¨

### 4. ç³»ç»Ÿæ¬¢è¿é¡µ

**æ¥å£**: `GET /`

**åŠŸèƒ½**: è¿”å›åˆ†é…å™¨æœåŠ¡çš„åŸºæœ¬ä¿¡æ¯

**å“åº”æ ¼å¼**:
```json
{
  "message": "æ¬¢è¿ä½¿ç”¨æ·±åº¦é‰´ä¼ªæ¥å£ï¼",
  "documentation": "æ¥å£ä½¿ç”¨æ–¹æ³•è¯·è¯¦ç»†é˜…è¯»ç›¸å…³æ–‡æ¡£ã€‚",
  "status": 200
}
```

### 5. ç»Ÿè®¡æ¥å£

**æ¥å£**: `POST /stats` å’Œ `GET /stats`

**åŠŸèƒ½**: è®°å½•è®¿é—®ç»Ÿè®¡å’ŒæŸ¥è¯¢ç»Ÿè®¡æ•°æ®

**POSTè¯·æ±‚**ï¼ˆè®°å½•è®¿é—®ï¼‰:
```json
{
  "message": "Visit recorded."
}
```

**GETè¯·æ±‚**ï¼ˆæŸ¥è¯¢ç»Ÿè®¡ï¼Œéœ€è¦APIå¯†é’¥ï¼‰:
```http
GET /stats?key=authen
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—ç³»ç»Ÿ

```bash
# æ—¥å¿—æ–‡ä»¶ä½ç½®
logs/
â”œâ”€â”€ distributer.log          # åˆ†é…å™¨ä¸»æ—¥å¿—
â””â”€â”€ error.log               # é”™è¯¯æ—¥å¿—

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/distributer.log

# æœç´¢é”™è¯¯ä¿¡æ¯
grep -i "error\|exception" logs/distributer.log

# æŸ¥çœ‹æœ€è¿‘çš„ä»»åŠ¡åˆ†å‘è®°å½•
grep "task" logs/distributer.log | tail -10
```

### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹åˆ†é…å™¨æ€§èƒ½æŒ‡æ ‡
curl http://localhost:5000/simplecheck

# ç›‘æ§ç«¯å£è¿æ¥æ•°
ss -t | grep :5000 | wc -l

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
ps aux | grep distributer.py

# æŸ¥çœ‹å®æ—¶ç½‘ç»œæµé‡
iftop -i eth0 -P
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### 1. æ£€æµ‹æœåŠ¡è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ£€æµ‹æœåŠ¡çŠ¶æ€
curl http://localhost:35331/statuscheck

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
telnet localhost 35331

# æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®
sudo ufw status
```

#### 2. ä»»åŠ¡åˆ†å‘å¼‚å¸¸
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat config.yml

# éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
python -c "import yaml; print(yaml.safe_load(open('config.yml')))"

# é‡å¯åˆ†é…å™¨æœåŠ¡
screen -S cucdfd_distributer -X quit
screen -dmS cucdfd_distributer python distributer.py
```

#### 3. æ–‡ä»¶ä¸‹è½½å¤±è´¥
```bash
# æ£€æŸ¥staticç›®å½•æƒé™
ls -la static/

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
find static/ -type d -mtime +7 -exec rm -rf {} \;
```

## ğŸ”§ é«˜çº§é…ç½®

### æ–‡ä»¶å¤§å°é™åˆ¶

åœ¨`distributer.py`ä¸­ä¿®æ”¹æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶ï¼š

```python
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB
```

### çŠ¶æ€æ£€æŸ¥é¢‘ç‡

ä¿®æ”¹æ£€æµ‹æœåŠ¡çŠ¶æ€æ£€æŸ¥é—´éš”ï¼š

```python
Timer(5, update_server_status).start()  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
```

### é›†ç¾¤éƒ¨ç½²

```yaml
# å¤šæœºå™¨é›†ç¾¤é…ç½®
distributer_module:
  worker_servers:
    # æœ¬åœ°æœåŠ¡å™¨
    - name: "local_service_1"
      url: "http://localhost:35331"
    - name: "local_service_2"
      url: "http://localhost:35332"
    
    # è¿œç¨‹æœåŠ¡å™¨
    - name: "remote_service_1"
      url: "http://192.168.1.101:35331"
    - name: "remote_service_2"
      url: "http://192.168.1.102:35331"
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
distributer/
â”œâ”€â”€ distributer.py              # ä¸»æœåŠ¡æ–‡ä»¶
â”œâ”€â”€ config.yml                  # æœ¬åœ°é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ README.md                   # æœ¬æ–‡æ¡£
â”œâ”€â”€ utils/                      # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ statis.py              # ç»Ÿè®¡åŠŸèƒ½
â”‚   â”œâ”€â”€ wgetdl.py              # åª’ä½“ä¸‹è½½å™¨
â”‚   â””â”€â”€ task_utils.py          # ä»»åŠ¡ç®¡ç†å·¥å…·
â””â”€â”€ static/                    # ç»“æœæ–‡ä»¶å­˜å‚¨ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
    â””â”€â”€ {taskid}/              # æŒ‰ä»»åŠ¡IDåˆ†ç»„çš„ç»“æœæ–‡ä»¶
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®ä¸»æ–‡æ¡£](../README.md) - å®Œæ•´ç³»ç»Ÿè¯´æ˜
- [æ£€æµ‹æœåŠ¡æ–‡æ¡£](../cucdfd_service/README.md) - æ£€æµ‹æœåŠ¡è¯¦ç»†è¯´æ˜
- [Webå‰ç«¯æ–‡æ¡£](../web/README.md) - Webç•Œé¢ä½¿ç”¨è¯´æ˜
- [ç¯å¢ƒé…ç½®æŒ‡å—](../appendices/environment/env%20setup.md) - ç¯å¢ƒå®‰è£…é…ç½®